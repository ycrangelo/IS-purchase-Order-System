{% extends "base.html" %}

{% block title %}Inventory{% endblock %}

{% block content %}
<div class="d-flex flex-row justify-content-between">
    <h1>Inventory</h1>
   <!-- Button to trigger modal -->
<button type="button" class="btn btn-primary " data-bs-toggle="modal" data-bs-target="#exampleModal">
    Create
</button>
</div>

<!-- Modal -->
<div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Create Inventory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5 id="error-message" style="display: none">
                    Please fill up correctly. make sure the Price and Quantity are numbers.
                  </h5>
                    <div class="input-group mb-3">
                        <input type="text" id="codeId" name="codeId" class="form-control" placeholder="Code ID" aria-label="Username" aria-describedby="basic-addon1">
                      </div>
                      <div class="input-group mb-3">
                        <input type="text" id="description" name="description" class="form-control" placeholder="Description" aria-label="Username" aria-describedby="basic-addon1">
                      </div>
                      <div class="input-group mb-3">
                        <input type="text" id="location" name="location" class="form-control" placeholder="Location" aria-label="Username" aria-describedby="basic-addon1">
                      </div>
                      <div class="input-group mb-3">
                        <input type="text" id="price" name="price" class="form-control" placeholder="Price" aria-label="Username" aria-describedby="basic-addon1">
                      </div>
                      <div class="input-group mb-3">
                        <input type="text" id="quantity" name="quantity" class="form-control" placeholder="Quantity" aria-label="Username" aria-describedby="basic-addon1">
                      </div>
                    <div class="d-flex justify-content-end w-100">
                        <button type="button" class="btn btn-success" id="saveInventory">Save</button>
                    </div>
            </div>                    
        </div>
    </div>
</div>


<!-- Modal edit -->
<div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" id="modalEdit" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEdit">Edit Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5 id="error-message-edit" style="display: none">
                    Please fill up correctly. make sure the Price and Quantity are numbers.
                  </h5>
                    <div class="input-group mb-3">
                      <span style="font-weight: 700;" class="">Code ID:</span>
                        <div class="input-group">
                            <input type="text" id="codeIdEdit" name="codeId" class="form-control" placeholder="Code ID" aria-label="Username" aria-describedby="basic-addon1">
                        </div>
                      </div>
                      <div class="input-group mb-3">
                        <span style="font-weight: 700;" class="">Description:</span>
                        <div class="input-group">
                        <input type="text" id="descriptionEdit" name="description" class="form-control" placeholder="Description" aria-label="Username" aria-describedby="basic-addon1">
                        </div>
                      </div>
                      <div class="input-group mb-3">
                        <span style="font-weight: 700;" class="">Location:</span>
                        <div class="input-group">
                        <input type="text" id="locationEdit" name="location" class="form-control" placeholder="Location" aria-label="Username" aria-describedby="basic-addon1">
                    </div>
                      </div>
                      <div class="input-group mb-3">
                        <span style="font-weight: 700;" class="">Price:</span>
                        <div class="input-group">
                        <input type="text" id="priceEdit" name="price" class="form-control" placeholder="Price" aria-label="Username" aria-describedby="basic-addon1">
                    </div>
                      </div>
                      <div class="input-group mb-3">
                        <span style="font-weight: 700;" class="">Quantity:</span>
                        <div class="input-group">
                        <input type="text" id="quantityEdit" name="quantity" class="form-control" placeholder="Quantity" aria-label="Username" aria-describedby="basic-addon1">
                    </div>
                      </div>
                    <div class="d-flex justify-content-end w-100">
                        <button type="button" class="btn btn-success" id="saveEditInventory">Save</button>
                    </div>
            </div>                    
        </div>
    </div>
</div>

<!-- Modal edit quantity -->
<div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" id="modalEditQuantity" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="modalEdit">Edit Quantity</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <h5 id="error-message-edit-quantity" style="display: none">
                  Please fill up correctly. make sure the Quantity is a number.
                </h5>
                    <div class="input-group mb-3">
                      <span style="font-weight: 700;" class="">Description:</span>
                      <div class="input-group">
                      <input disabled type="text" id="descriptionEditQuantity" name="description" class="form-control" placeholder="Description" aria-label="Username" aria-describedby="basic-addon1">
                      </div>
                    </div>
                    <div class="input-group mb-3">
                      <span style="font-weight: 700;" class="">Quantity:</span>
                      <div class="input-group">
                      <input type="text" id="quantityEditQuantity" name="quantity" class="form-control" placeholder="Quantity" aria-label="Username" aria-describedby="basic-addon1">
                  </div>
                    </div>
                  <div class="d-flex justify-content-end w-100">
                      <button type="button" class="btn btn-success" id="saveEditInventoryQuantity">Save</button>
                  </div>
          </div>                    
      </div>
  </div>
</div>
<div class="mb-3 mt-5">
  <input 
    type="text" 
    class="form-control" 
    id="searchInput" 
    placeholder="Search item..." 
    style="max-width: 10rem;"
  >
</div>
{% if logs %}
            <table class="table mt-3" id="usersTable">
                <thead>
                    <tr>
                        <th></th>
                        <th>Description</th>
                        <th>Location</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>status</th>
                    </tr>
                </thead>
                <tbody>
    {% for log in logs %}
    <tr data-id="{{ log[0] }}" 
    data-codeid="{{ log[1] }}"
    data-description="{{ log[2] }}"
    data-location="{{ log[3] }}"
    data-price="{{ log[7] }}"
    data-quantity="{{ log[4] }}">
    <td>
        <div>
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalEditQuantity" id="editQuantity">
                <i class="bi bi-exposure"></i>
            </button>
            <button type="button" class="btn btn-warning edit-btn" data-bs-toggle="modal" data-bs-target="#modalEdit">
                <i class="bi bi-pencil-square"></i>
            </button>
            <button type="button" class="btn btn-danger" id="deactivation">
                <i class="bi bi-x-circle-fill"></i>
            </button>
        </div>
    </td>
    <td>{{ log[2] }}</td>
    <td>{{ log[3] }}</td> 
    <td class="d-flex">
        {% if log[4]|int < 20 %}
            <p style="color: red;">{{ log[4] }}</p>
        {% else %}
            <p style="color: green;">{{ log[4] }}</p>
        {% endif %}
    </td>                           
    <td>{{ log[7] }}</td> 
    <td class="">
      {% if log[8]|int ==0 %}
          <p style="color: red;"> Deactivate</p>
      {% else %}
          <p style="color: green;">Active</p>
      {% endif %}
  </td> 
</tr>
    {% endfor %}
</tbody>
            </table>
        {% else %}
            <p>No logs found.</p>
        {% endif %}
            <!-- Pagination -->
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center" id="pagination">
          <!-- Pagination links will be added by JavaScript -->
      </ul>
  </nav>
</div>
<!-- Include jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- Bootstrap CSS -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap JS and dependencies -->
 <!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Include the full version of jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap JS (including Popper.js) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script type="text/javascript">
  $(document).ready(function() {
    // Initialize variables
    var rowsPerPage = 10;
    var $table = $('#usersTable');
    var $tbody = $table.find('tbody');
    var $originalRows = $tbody.find('tr');
    var $rows = $originalRows;
    var totalRows = $rows.length;
    var pageCount = Math.ceil(totalRows / rowsPerPage);
    var currentPage = 1;
    var maxVisiblePages = 6; // Maximum number of visible page buttons
    
    // Create a no results row
    var $noResults = $('<tr><td colspan="5" class="text-center">No results found</td></tr>');
    
    // Function to initialize pagination
    function initPagination() {
        var $pagination = $('#pagination');
        $pagination.empty();
        
        // Add Previous button
        $pagination.append('<li class="page-item"><a class="page-link" href="#" id="prevPage">&laquo;</a></li>');
        
        // Calculate range of pages to show
        var startPage, endPage;
        if (pageCount <= maxVisiblePages) {
            startPage = 1;
            endPage = pageCount;
        } else {
            var maxPagesBeforeCurrent = Math.floor(maxVisiblePages / 2);
            var maxPagesAfterCurrent = Math.ceil(maxVisiblePages / 2) - 1;
            
            if (currentPage <= maxPagesBeforeCurrent) {
                startPage = 1;
                endPage = maxVisiblePages;
            } else if (currentPage + maxPagesAfterCurrent >= pageCount) {
                startPage = pageCount - maxVisiblePages + 1;
                endPage = pageCount;
            } else {
                startPage = currentPage - maxPagesBeforeCurrent;
                endPage = currentPage + maxPagesAfterCurrent;
            }
        }
        
        // Add first page with ellipsis if needed
        if (startPage > 1) {
            $pagination.append('<li class="page-item"><a class="page-link" href="#">1</a></li>');
            if (startPage > 2) {
                $pagination.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
            }
        }
        
        // Add page numbers in range
        for (var i = startPage; i <= endPage; i++) {
            var activeClass = i === currentPage ? ' active' : '';
            $pagination.append(
                '<li class="page-item' + activeClass + '"><a class="page-link" href="#">' + i + '</a></li>'
            );
        }
        
        // Add last page with ellipsis if needed
        if (endPage < pageCount) {
            if (endPage < pageCount - 1) {
                $pagination.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
            }
            $pagination.append('<li class="page-item"><a class="page-link" href="#">' + pageCount + '</a></li>');
        }
        
        // Add Next button
        $pagination.append('<li class="page-item"><a class="page-link" href="#" id="nextPage">&raquo;</a></li>');
        
        // Show stored page or first page by default
        var storedPage = localStorage.getItem('usersCurrentPage');
        if (storedPage && storedPage <= pageCount) {
            currentPage = parseInt(storedPage);
        }
        showPage(currentPage);
    }
    
    // Load stored search term if exists
    var storedSearch = localStorage.getItem('usersLastSearch');
    if (storedSearch) {
        $('#searchInput').val(storedSearch);
        performSearch(storedSearch);
    } else {
        initPagination();
    }
    
    // Pagination click handlers
    $('#pagination').on('click', 'a.page-link:not(#prevPage):not(#nextPage)', function(e) {
        e.preventDefault();
        currentPage = parseInt($(this).text());
        localStorage.setItem('usersCurrentPage', currentPage);
        showPage(currentPage);
        initPagination(); // Rebuild pagination to center on current page
    });
    
    $('#prevPage').on('click', function(e) {
        e.preventDefault();
        if (currentPage > 1) {
            currentPage--;
            localStorage.setItem('usersCurrentPage', currentPage);
            showPage(currentPage);
            initPagination();
        }
    });
    
    $('#nextPage').on('click', function(e) {
        e.preventDefault();
        if (currentPage < pageCount) {
            currentPage++;
            localStorage.setItem('usersCurrentPage', currentPage);
            showPage(currentPage);
            initPagination();
        }
    });
    
    // Search functionality
    $('#searchInput').on('keyup', function() {
        var searchText = $(this).val().toLowerCase();
        localStorage.setItem('usersLastSearch', searchText);
        performSearch(searchText);
    });
    
    // Function to perform search
    function performSearch(searchText) {
        // Remove no results row if it exists
        $noResults.detach();
        
        if (searchText === '') {
            // If search is empty, reset to original state
            localStorage.removeItem('usersLastSearch');
            $rows = $originalRows;
            totalRows = $rows.length;
            pageCount = Math.ceil(totalRows / rowsPerPage);
            currentPage = 1;
            initPagination();
            return;
        }
        
        // Filter rows
        var hasResults = false;
        $rows = $originalRows.filter(function() {
            var rowText = $(this).text().toLowerCase();
            var isMatch = rowText.indexOf(searchText) > -1;
            if (isMatch) hasResults = true;
            return isMatch;
        });
        
        totalRows = $rows.length;
        pageCount = Math.ceil(totalRows / rowsPerPage);
        currentPage = 1;
        
        // Show no results message if no matches
        if (!hasResults) {
            $tbody.append($noResults);
        }
        
        // Reinitialize pagination with filtered results
        initPagination();
    }
    
    // Function to show specific page
    function showPage(pageNum) {
        var startIndex = (pageNum - 1) * rowsPerPage;
        var endIndex = startIndex + rowsPerPage;
        
        // Hide all rows
        $originalRows.hide();
        
        // Show either the no results message or the paginated rows
        if ($noResults.is(':visible')) {
            $noResults.show();
        } else {
            $rows.slice(startIndex, endIndex).show();
        }
        
        // Update active page in pagination
        $('#pagination').find('li').removeClass('active');
        $('#pagination').find('a').each(function() {
            if ($(this).text() == pageNum && !$(this).is('#prevPage, #nextPage')) {
                $(this).parent().addClass('active');
            }
        });
        
        // Enable/disable Previous and Next buttons
        $('#prevPage').parent().toggleClass('disabled', pageNum <= 1);
        $('#nextPage').parent().toggleClass('disabled', pageNum >= pageCount);
    }
});

  $(document).on("click", "#editQuantity", function () {
    // Get the row that was clicked
    var row = $(this).closest("tr");

    // Extract the data from the row
    var description = row.data("description");
    var quantity = row.data("quantity");
    var id = row.data("id");  // This is the unique id for the inventory item

    // Populate the modal with the extracted data
    $("#modalEditQuantity #descriptionEditQuantity").val(description);
    $("#modalEditQuantity #quantityEditQuantity").val(quantity);

    // Store the id (unique identifier) of the inventory item in the modal for later use
    $("#modalEditQuantity").data("itemId", id);
});


    //for edit quantity item
    $(document).on("click", "#saveEditInventoryQuantity", function (event) {
      var description = $.trim($("#descriptionEditQuantity").val()); // No need for encodeURI unless you're sending data 
      var quantity = $.trim($("#quantityEditQuantity").val());
      var itemId = $("#modalEditQuantity").data("itemId");
       console.log("description:", description);
       console.log("quantity:", quantity);
       console.log("itemId:", itemId);
       
  
      var isOk = 0;
      if (description == "") {
        isOk++;
        console.log(isOk);
      }
        // Regular expression to check if the value is not a number
        const regex = /^(?!\d+$).*/;

        if (quantity === "" || regex.test(quantity)) {
        isOk++;
        console.log(isOk);
        }
  
       if (isOk > 0) {
         $("#error-message-edit-quantity").css({
           display: "block", // Show the element
           color: "red", // Change the text color to red
         });
         isOk=0;
         setTimeout(function () {
           $("#error-message-edit-quantity").css({
             display: "none", // Show the element
             color: "red", 
           });
         }, 4000);
       } 
        else {
          $.ajax({
            url: "{{url_for('inventoryEditQuantity')}}",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ 
                id:itemId,
                description: description,
                quantity:quantity

            }),
            success: function (response) {
             setTimeout(function () {
           location.reload();
         }, 500);
         console.log(response);
              console.log(response);
            },
            error: function (error) {
              console.log(error);
            },
          });
        }
    });



$(document).on("click", "#deactivation", function (event) {
      var row = $(this).closest("tr");
      var id = row.data("id");  // This is the unique id for the inventory item
      var codeId = row.data("codeid");
         $.ajax({
           url: "{{url_for('inventoryDeactivation')}}",
           type: "POST",
           contentType: "application/json",
           data: JSON.stringify({
            id: id,
            codeId:codeId
           }),
           success: function (response) {
            setTimeout(function () {
          location.reload();
        }, 500);
        console.log(response);
             console.log(response);
           },
           error: function (error) {
             console.log(error);
           },
         });
       
    });

$(document).on("click", ".edit-btn", function () {
    // Get the row that was clicked
    var row = $(this).closest("tr");

    // Extract the data from the row
    var codeId = row.data("codeid");
    var description = row.data("description");
    var location = row.data("location");
    var price = row.data("price");
    var quantity = row.data("quantity");
    var id = row.data("id");  // This is the unique id for the inventory item

    // Populate the modal with the extracted data
    $("#modalEdit #codeIdEdit").val(codeId);
    $("#modalEdit #descriptionEdit").val(description);
    $("#modalEdit #locationEdit").val(location);
    $("#modalEdit #priceEdit").val(price);
    $("#modalEdit #quantityEdit").val(quantity);

    // Store the id (unique identifier) of the inventory item in the modal for later use
    $("#modalEdit").data("itemId", id);
});


    
    $(document).on("click", "#saveInventory", function (event) {
      var codeId = $.trim($("#codeId").val()); // No need for encodeURI unless you're sending data to a server
      var description = $.trim($("#description").val()); // No need for encodeURI unless you're sending data to a server
      var locationn = $.trim($("#location").val());
      var price = $.trim($("#price").val());
      var quantity = $.trim($("#quantity").val());
      var itemId = $("#modalEdit").data("itemId");
    //    var accountTypeButton = $.trim($("#accountTypeButton").text());
       console.log("codeId:", codeId);
       console.log("description:", description);
       console.log("location:", locationn);
       console.log("price:", price);
       console.log("quantity:", quantity);
       
  
      var isOk = 0;
      if (codeId == "") {
        isOk++;
        console.log(isOk);
      }
      if (description == "") {
        isOk++;
        console.log(isOk);
      }
      if (locationn == "") {
        isOk++;
        console.log(isOk);
      }
        // Regular expression to check if the value is not a number
        const regex = /^(?!\d+$).*/;

        // Check if price or quantity is empty or doesn't match a number
        if (price === "" || regex.test(price)) {
        isOk++;
        console.log(isOk);
        }

        if (quantity === "" || regex.test(quantity)) {
        isOk++;
        console.log(isOk);
        }
  
      if (isOk > 0) {
        $("#error-message").css({
          display: "block", // Show the element
          color: "red", // Change the text color to red
        });
        isOk=0;
        setTimeout(function () {
          $("#error-message").css({
            display: "none", // Show the element
            color: "red", // Change the text color to red
          });
        }, 4000);
      } 
       else {
         $.ajax({
           url: "{{url_for('inventoryCreate')}}",
           type: "POST",
           contentType: "application/json",
           data: JSON.stringify({
               codeId: codeId, 
               description: description,
               location: locationn,
               price: price,
               quantity:quantity

           }),
           success: function (response) {
            setTimeout(function () {
          location.reload();
        }, 500);
        console.log(response);
             console.log(response);
           },
           error: function (error) {
             console.log(error);
           },
         });
       }
    });


    //for edit item
    $(document).on("click", "#saveEditInventory", function (event) {
      var codeId = $.trim($("#codeIdEdit").val()); // No need for encodeURI unless you're sending data to a server
      var description = $.trim($("#descriptionEdit").val()); // No need for encodeURI unless you're sending data to a server
      var locationn = $.trim($("#locationEdit").val());
      var price = $.trim($("#priceEdit").val());
      var quantity = $.trim($("#quantityEdit").val());
      var itemId = $("#modalEdit").data("itemId");
    //    var accountTypeButton = $.trim($("#accountTypeButton").text());
       console.log("codeId:", codeId);
       console.log("description:", description);
       console.log("location:", locationn);
       console.log("price:", price);
       console.log("quantity:", quantity);
       console.log("itemId:", itemId);
       
  
      var isOk = 0;
      if (codeId == "") {
        isOk++;
        console.log(isOk);
      }
      if (description == "") {
        isOk++;
        console.log(isOk);
      }
      if (locationn == "") {
        isOk++;
        console.log(isOk);
      }
        // Regular expression to check if the value is not a number
        const regex = /^(?!\d+$).*/;

        // Check if price or quantity is empty or doesn't match a number
        if (price === "" || regex.test(price)) {
        isOk++;
        console.log(isOk);
        }

        if (quantity === "" || regex.test(quantity)) {
        isOk++;
        console.log(isOk);
        }
  
      if (isOk > 0) {
        $("#error-message-edit").css({
          display: "block", // Show the element
          color: "red", // Change the text color to red
        });
        isOk=0;
        setTimeout(function () {
          $("#error-message-edit").css({
            display: "none", // Show the element
            color: "red", // Change the text color to red
          });
        }, 4000);
      } 
       else {
         $.ajax({
           url: "{{url_for('inventoryEdit')}}",
           type: "POST",
           contentType: "application/json",
           data: JSON.stringify({ 
               id:itemId,
               codeId: codeId, 
               description: description,
               location: locationn,
               price: price,
               quantity:quantity

           }),
           success: function (response) {
            setTimeout(function () {
          location.reload();
        }, 500);
        console.log(response);
             console.log(response);
           },
           error: function (error) {
             console.log(error);
           },
         });
       }
    });
  </script>
{% endblock %}
