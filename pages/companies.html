{% extends "base.html" %} {% block title %}Users{% endblock %} {% block content
%}

<!-- Modal account type -->
<div
  class="modal fade"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
  id="exampleModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Create Account Type</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="input-group mb-3">
          <input
            type="text"
            id="accountType"
            name="accountType"
            class="form-control"
            placeholder="Account Type"
            aria-label="Username"
            aria-describedby="basic-addon1"
          />
        </div>
        <div class="input-group mb-3">
          <input
            type="text"
            id="status"
            name="status"
            class="form-control"
            placeholder="Status"
            aria-label="Username"
            aria-describedby="basic-addon1"
          />
        </div>
        <div class="d-flex justify-content-end w-100">
          <button type="button" class="btn btn-success" id="saveAccountType">
            Save
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal edit password -->
<div
  class="modal fade"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
  id="modalChangePassword"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEdit">Change Password</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <h5 id="error-message-password" style="display: none">
          Please fill up correctly.
        </h5>
        <div class="input-group mb-3">
          <span style="font-weight: 700"> Old Password:</span>
          <div class="input-group">
            <input
              type="text"
              id="passwordEdit"
              name="quantity"
              class="form-control"
              placeholder="Password"
              aria-label="Username"
              aria-describedby="basic-addon1"
              disabled
            />
          </div>
        </div>
        <div class="input-group mb-3">
          <span style="font-weight: 700"> New Password:</span>
          <div class="input-group">
            <input
              type="text"
              id="passwordEditNew"
              name="quantity"
              class="form-control"
              placeholder="Password"
              aria-label="Username"
              aria-describedby="basic-addon1"
            />
          </div>
        </div>
        <div class="d-flex justify-content-end w-100">
          <button type="button" class="btn btn-success" id="savechangePass">
            Save
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal user -->
<div
  class="modal fade"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
  id="createUser"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Create Company</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <h3 id="error-message-edit-company" style="display: none">
          Please fill up correctly
        </h3>
        <!-- Dropdown for account type -->
        <div class="input-group mb-3 mt-3">
          <input
            type="text"
            id="companyName"
            name="companyName"
            class="form-control"
            placeholder="Company Name"
            aria-label="Username"
            aria-describedby="basic-addon1"
          />
        </div>
        <div class="input-group mb-3">
          <input
            type="text"
            id="contactPerson"
            name="contactPerson"
            class="form-control"
            placeholder="Contact Person"
            aria-label="Username"
            aria-describedby="basic-addon1"
          />
        </div>
        <div class="input-group mb-3">
          <input
            type="text"
            id="username"
            name="username"
            class="form-control"
            placeholder="User Name"
            aria-label="Username"
            aria-describedby="basic-addon1"
          />
        </div>
        <div class="input-group mb-3">
          <input
            type="text"
            id="password"
            name="password"
            class="form-control"
            placeholder="Password"
            aria-label="Username"
            aria-describedby="basic-addon1"
          />
        </div>
        <div class="d-flex justify-content-end w-100">
          <button type="button" class="btn btn-success" id="saveCompany">
            Save
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal user update -->
<div
  class="modal fade"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
  id="EditUser"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Edit Company</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <h3 id="error-message" style="display: none">
          Please fill up correctly
        </h3>
        <!-- Dropdown for account type -->
        <div class="input-group mb-3">
          <span style="font-weight: 700" class="">Company Name:</span>
          <div class="input-group">
            <input
              type="text"
              id="editCompanyName"
              name="description"
              class="form-control"
              placeholder="Company Name"
              aria-label="Username"
              aria-describedby="basic-addon1"
            />
          </div>
        </div>
        <div class="input-group mb-3">
          <span style="font-weight: 700" class="">Contact Person:</span>
          <div class="input-group">
            <input
              type="text"
              id="editContactPerson"
              name="description"
              class="form-control"
              placeholder="Contact Person"
              aria-label="Username"
              aria-describedby="basic-addon1"
            />
          </div>
        </div>
        <div class="input-group mb-3">
          <span style="font-weight: 700" class="">Username:</span>
          <div class="input-group">
            <input
              type="text"
              id="editUsername"
              name="description"
              class="form-control"
              placeholder="Username"
              aria-label="Username"
              aria-describedby="basic-addon1"
            />
          </div>
        </div>
        <div class="d-flex justify-content-end w-100">
          <button type="button" class="btn btn-success" id="saveEditCompany">
            Save
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="">
  <div class="d-flex justify-content-between w-100">
    <h1>Companies</h1>
    <button
      type="button"
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#createUser"
    >
      Create company
    </button>
  </div>
  <div class="container">
    {% if logs %}
    <table class="table mt-3">
      <thead>
        <tr>
          <th></th>
          <th>Company Name</th>
          <th>Contact Person</th>
          <th>Username</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr
          data-id ="{{ log[0] }}"
          data-company-name ="{{ log[1] }}"
          data-contact-person ="{{ log[2] }}"
          data-username ="{{ log[3] }}"
          data-password ="{{ log[4] }}"
          data-status ="{{ log[6] }}"
        >
          <td>
            <div>
              <button
                type="button"
                class="btn btn-primary edit-password"
                data-bs-toggle="modal"
                data-bs-target="#modalChangePassword"
              >
                <i class="bi bi-person-fill-lock"></i>
              </button>
              <button
                type="button"
                class="btn btn-warning edit-btn"
                data-bs-toggle="modal"
                data-bs-target="#EditUser"
              >
                <i class="bi bi-pencil-square"></i>
              </button>
              <button type="button" class="btn btn-danger" id="deactivation">
                <i class="bi bi-x-circle-fill"></i>
              </button>
            </div>
          </td>
          <td>{{ log[1] }}</td>
          <td>{{ log[2] }}</td>
          <td>{{ log[3] }}</td>
          <td>
            {% if log[6]|int ==0 %}
            <p style="color: red">Deactivate</p>
            {% else %}
            <p style="color: green">Active</p>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No logs found.</p>
    {% endif %}
  </div>
</div>

<!-- Include jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- Bootstrap CSS -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<!-- Bootstrap JS (includes Popper.js) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScript to update button text -->
<script>
  function updateButtonText(selectedText) {
    // Update the button text with the selected item
    document.getElementById("accountTypeButton").innerText = selectedText;
  }
</script>

<!-- JavaScript for AJAX and other functionality -->
<script type="text/javascript">
  

  $(document).on("click", "#saveEditCompany", function (event) {
    var editCompanyName = $.trim($("#editCompanyName").val()); // Fixed typo: removed extra space
    var editContactPerson = $.trim($("#editContactPerson").val()); // Fixed typo: removed extra space
    var EditUsername = $.trim($("#editUsername").val()); // Fixed typo: removed extra space
    var itemId = $("#EditUser").data("itemId"); // Get the itemId from the modal

    console.log('username here :',EditUsername)
    console.log('editContactPerson here :',editContactPerson)
    console.log('editCompanyName here :',editCompanyName)

    console.log("itemId:", itemId);

    var isOk = 0;
    if (editCompanyName == "") {
      isOk++;
      console.log(" editCompanyName isok:",isOk);
    }
    if (editContactPerson == "") {
      isOk++;
      console.log(" editContactPerson isok:",isOk);
    }
    if (EditUsername == "") {
      isOk++;
      console.log(" EditUsername isok:",isOk);
    }

    if (isOk > 0) {
      $("#error-message-edit-company").css({
        display: "block", // Show the element
        color: "red", // Change the text color to red
      });
      isOk = 0;
      setTimeout(function () {
        $("#error-message-edit-company").css({
          display: "none", // Show the element
          color: "red", // Change the text color to red
        });
      }, 4000);
    }
     else {
      $.ajax({
        url: "{{url_for('companiesEdit')}}", // Ensure this URL matches your Flask route
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
          id: itemId, // Use itemId instead of codeId
          editCompanyName: editCompanyName, // Send only the new password
          editContactPerson:editContactPerson,
          EditUsername:EditUsername
        }),
        success: function (response) {
          setTimeout(function () {
            location.reload();
          }, 500);
          console.log(response);
        },
        error: function (error) {
          console.log(error);
        },
      });
    }
  });

  $(document).on("click", "#savechangePass", function (event) {
    var passwordEditNew = $.trim($("#passwordEditNew").val()); // Fixed typo: removed extra space
    var itemId = $("#modalChangePassword").data("itemId"); // Get the itemId from the modal

    console.log("itemId:", itemId);
    console.log("passwordEditNew:", passwordEditNew);

    var isOk = 0;
    if (passwordEditNew == "") {
      isOk++;
      console.log(isOk);
    }

    if (isOk > 0) {
      $("#error-message-password").css({
        display: "block", // Show the element
        color: "red", // Change the text color to red
      });
      isOk = 0;
      setTimeout(function () {
        $("#error-message-password").css({
          display: "none", // Show the element
          color: "red", // Change the text color to red
        });
      }, 4000);
    } else {
      $.ajax({
        url: "{{url_for('comChange_password')}}", // Ensure this URL matches your Flask route
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
          id: itemId, // Use itemId instead of codeId
          newPassword: passwordEditNew, // Send only the new password
        }),
        success: function (response) {
          setTimeout(function () {
            location.reload();
          }, 500);
          console.log(response);
        },
        error: function (error) {
          console.log(error);
        },
      });
    }
  });

  $(document).on("click", ".edit-password", function () {
    // Get the row that was clicked
    var row = $(this).closest("tr");
    // Extract the data from the row
    var fullname = row.data("fullname");
    var password = row.data("password");
    var id = row.data("id"); // This is the unique id for the user

    // Populate the modal with the extracted data
    $("#modalChangePassword #passwordEdit").val(password);
    // Store the id (unique identifier) of the user in the modal for later use
    $("#modalChangePassword").data("itemId", id);
  });

  $(document).on("click", ".edit-btn", function () {
    // Get the row that was clicked
    var row = $(this).closest("tr");
    // Extract the data from the row
    var companyName = row.data("company-name");
    var contactPerson = row.data("contact-person");
    var username = row.data("username");
    var id = row.data("id"); // This is the unique id for the user
    console.log(companyName)
    console.log(contactPerson)
    console.log(username)

    // Populate the modal with the extracted data
    $("#EditUser #editCompanyName").val(companyName);
    $("#EditUser #editContactPerson").val(contactPerson);
    $("#EditUser #editUsername").val(username);
    // Store the id (unique identifier) of the user in the modal for later use
    $("#EditUser").data("itemId", id);
  });

  $(document).on("click", "#deactivation", function (event) {
    var row = $(this).closest("tr");
    var id = row.data("id"); // This is the unique id for the inventory item
    var codeId = row.data("company-name");
    console.log(codeId);
    console.log(id);
    $.ajax({
      url: "{{url_for('companyDeactivation')}}",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        id: id,
        codeId: codeId,
      }),
      success: function (response) {
        setTimeout(function () {
          location.reload();
        }, 500);
        console.log(response);
      },
      error: function (error) {
        console.log(error);
      },
    });
  });

  $(document).on("click", "#saveCompany", function (event) {
    var companyName = $.trim($("#companyName").val());
    var contactPerson = $.trim($("#contactPerson").val());
    var username = $.trim($("#username").val());
    var password = $.trim($("#password").val());

    console.log(`company name ${companyName}`);
    console.log(`contactPerson ${contactPerson}`);
    console.log(`username  ${username}`);
    console.log(`password ${password}`);

    var isOk = 0;
    if (companyName == "") {
      isOk++;
      console.log(isOk);
    }
    if (contactPerson == "") {
      isOk++;
      console.log(isOk);
    }
    if (username == "") {
      isOk++;
      console.log(isOk);
    }
    if (password == "") {
      isOk++;
      console.log(isOk);
    }

    if (isOk > 0) {
      $("#error-message").css({
        display: "block", // Show the element
        color: "red", // Change the text color to red
      });
      isOk = 0;
      setTimeout(function () {
        $("#error-message").css({
          display: "none", // Show the element
          color: "red", // Change the text color to red
        });
      }, 4000);
    } else {
      $.ajax({
        url: "{{url_for('createCompany')}}",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
          companyName: companyName,
          contactPerson: contactPerson,
          username: username,
          password: password,
        }),
        success: function (response) {
          setTimeout(function () {
            location.reload();
          }, 500);
          console.log(response);
        },
        error: function (error) {
          console.log(error);
        },
      });
    }
  });
</script>
{% endblock %}
